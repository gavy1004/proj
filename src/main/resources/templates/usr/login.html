<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>login</title>

    <!-- sweetAlert2 -->
    <link rel="stylesheet" th:href="@{/plugins/sweetalert2/sweetalert2.min.css}">

    <!-- jquery -->
    <script th:src="@{/plugins/jquery/jquery-3.6.1.min.js}"></script>
    <script th:src="@{/plugins/jquery-serialize-object/jquery.serialize-object.min.js}"></script>
    <!-- jquery-validate -->
    <script th:src="@{/plugins/jquery-validation/jquery.validate.min.js}"></script>
    <!-- jquery-ui -->
    <script th:src="@{/plugins/jquery-ui/jquery-ui.js}"></script>
    <!-- axios -->
    <script th:src="@{/plugins/axios/axios.min.js}"></script>
    <!-- sweetAlert2 -->
    <script th:src="@{/plugins/sweetalert2/sweetalert2.min.js}"></script>

    <!-- 커스텀 sweetAlert -->
    <script th:src="@{/js/cmm/CustomAlert.js}"></script>
    <!-- form validation 기능 -->
    <script th:src="@{/js/cmm/Validation.js}"></script>

    <script>
        const validation = new Validation();
    </script>

</head>
<body>
    <h1></h1>
    <form id="loginForm" onsubmit="return false";>
        <input type="text" name="userId" placeholder="아이디 입력해 주세요">
        <input type="password" name="userPwd" placeholder="비밀번호를 입력해 주세요">
        <button type="submit" id="loginBtn"> 로그인 </button>
        <input type="checkBox" name="saveId"> 아이디 저장 
    </form>

    <h1></h1>
    <form id="joinForm" onsubmit="return false";>
        <input type="text" name="userName" placeholder="이름을 입력해 주세요">
        <input type="text" name="userId" onkeyup="duplicationId(this);" placeholder="아이디를 입력해 주세요">
        <input type="password" name="userPwd" placeholder="비밀번호를 입력해 주세요">
        <button type="submit" id="joinBtn"> 회원가입 </button>
    </form>
    <p id="duplicateArm"></p>

<script>

    // window on load fund()
    document.addEventListener('DOMContentLoaded', function() {
        
    });
    
    // ID 중복체크 
    function duplicationId(input){
        const id = input.value;
        const arrTag = document.getElementById("duplicateArm");

        try{
            if(id != ""){
                const url = "/user/findByUserId";
                const formData = new URLSearchParams($("#joinForm").serialize());
                
                axios
                .post(url, data)
                //.post(url, formData)
                .then(function (response) {
                    arrTag.innerText = response.data ? "중복된아이디입니다." : "사용가능한아이디입니다.";
                })
                .catch(function (error) {
                    CustomAlert.error(error.response.data);
                });
            }else{
                arrTag.innerText = "";
            }
        }catch(e){
            CustomAlert.error(error.response.data);
        }
    };

    // 로그인
    $("#loginForm").submit(function(){

        if(validation.form("loginForm", validation.loginRule)){
            const url = "user/actionLogin";
            const formData = new URLSearchParams($("#loginForm").serialize());
            try{
                axios
                    .post(url,formData)
                    .then(function(response){   
                        console.log(response)
                        if(response.status == 200){
                            location.href = "/login";
                        }
                    })
                    .catch(function(error){
                        
                        CustomAlert.error(error.response.data);
                    })
            }catch (e){
                CustomAlert.error(e.response.data)
            }
        }
    
    });

    // 회원가입
    $("#joinForm").submit(function(){
        CustomAlert.confirm("회원가입 하시겠습니까?", function(){
            if (validation.form("joinForm", validation.joinRule)){
                const url = "/user/join"
                const formData = new URLSearchParams($("#joinForm").serialize());
                try{
                    axios
                        .post(url, formData)
                        .then(function(response){
                            CustomAlert.success("회원가입에 성공했습니다.");
                            $(".swal2-actions").click(function(){
                                location.href = "/login";
                            });
                        })
                        .catch(function(error){
                            CustomAlert.error(error.response.data);
                        });
                }catch (e){
                    CustomAlert.error(e.response.data)
                }
            }
        })
    });

</script>

</body>
</html>